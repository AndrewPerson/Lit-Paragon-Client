<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="shortcut icon" type="image/webp" href="icons/128.webp" />
    
    <title>Paragon</title>
    
    <base href="/" />

    <link href="css/app.css" rel="stylesheet" />
    <link href="css/navbar.css" rel="stylesheet" />
    <link href="css/barcode.css" rel="stylesheet" />

    <link href="manifest.json" rel="manifest" />

    <script src="scripts/jsbarcode.js"></script>

    <script type="module" src="elements/main-elements.js"></script>
</head>

<body class="laptop-screen">
    <script src="main.js"></script>

    <nav-bar></nav-bar>

    <main id="main">
        <p id="info">Tap in two places to form the barcode</p>
        
        <div>
            <canvas id="barcode"></canvas>
            <img id="point1" draggable="false" src="images/circle.svg" />
            <img id="point2" draggable="false" src="images/circle.svg" />
        </div>

        <button title="Edit" onclick="RequestBarcodeSize()">
            <img draggable="false" style="width: inherit; height: inherit;" src="images/edit.svg" />
        </button>
    </main>

    <script>
        var id;
        var loadingElement;

        var point1 = document.getElementById("point1");
        var point2 = document.getElementById("point2");

        var info = document.getElementById("info");

        var barcode = document.getElementById("barcode");

        async function RequestBarcodeSize() {
            info.style.display = "unset";
            barcode.style.display = "none";

            point1.style.display = "none";
            point2.style.display = "none";

            var userInput = new Promise(resolve => {
                var clicks = 0;
                main.addEventListener("pointerdown", event => {
                    clicks++;

                    if (clicks == 1) {
                        point1.style.left = `${event.clientX - 10}px`;
                        point1.style.top = `${event.clientY - 10}px`;
                        point1.style.display = "unset";
                    }
                    else if (clicks == 2) {
                        point2.style.left = `${event.clientX - 10}px`;
                        point2.style.top = `${event.clientY - 10}px`;
                        point2.style.display = "unset";

                        document.removeEventListener("pointerdown", this);

                        resolve();
                    }
                });
            });

            await userInput;

            info.style.display = "none";

            barcode.style.display = "unset";
            UpdateBarcodeSize();
        }

        function UpdateBarcodeSize() {
            if (id) {
                var x1 = Number.parseInt(point1.style.left.replace("px", ""));
                var y1 = Number.parseInt(point1.style.top.replace("px", ""));

                var x2 = Number.parseInt(point2.style.left.replace("px", ""));
                var y2 = Number.parseInt(point2.style.top.replace("px", ""));

                var maxX;
                var minX;

                var maxY;
                var minY;

                if (x1 > x2) {
                    maxX = x1;
                    minX = x2;
                }
                else {
                    maxX = x2;
                    minX = x1;
                }

                if (y1 > y2) {
                    maxY = y1;
                    minY = y2;
                }
                else {
                    maxY = y2;
                    minY = y1;
                }

                if (maxX - minX > maxY - minY) {
                    barcode.style.top = (minY + 10) + "px";
                    barcode.style.left = (minX + 10) + "px";

                    barcode.style.width = (maxX - minX) + "px";
                    barcode.style.height = (maxY - minY) + "px";

                    barcode.style.transform = "";
                }
                else {
                    var width = maxX - minX;
                    var height = maxY - minY;

                    barcode.style.top = (minY + 10) + "px";
                    barcode.style.left = (minX + 10) + "px";

                    barcode.style.width = height + "px";
                    barcode.style.height = width + "px";

                    barcode.style.transform = "rotate(90deg) translate(" + (height / 2 - width / 2) + "px, " + (-width / 2 + height / 2) + "px)";
                }

                JsBarcode(barcode, id, {
                    displayValue: false,
                    margin: 0
                });
            }
        }

        async function onUserData() {
            var userInfo = await GetResourceFromCache("userinfo");

            if (!userInfo) {
                loadingElement = document.createElement("loading-element");

                loadingElement.style = "width: 80%";

                document.getElementById("main").appendChild(loadingElement);

                return;
            }

            if (loadingElement)
                loadingElement.remove();

            id = JSON.parse(userInfo).studentId;

            barcode.imageSmoothingEnabled = false;
            RequestBarcodeSize();
        }
    </script>
</body>

</html>
